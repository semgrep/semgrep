# AUTOGENERATED FROM release-homebrew.jsonnet DO NOT MODIFY
name: release-homebrew
"on":
  workflow_dispatch:
    inputs:
      version:
        type: string
        description: "\n        The version of Semgrep to release on Homebrew (e.g.,
          1.55.2)\n      "
        required: true
      dry-run:
        type: boolean
        description: "\n        Check the box for a dry-run.\n        A dry-run will
          not push any external state.\n      "
        default: false
        required: true
jobs:
  homebrew-core-pr:
    runs-on: macos-12
    steps:
    - run: brew update
    - name: 'ugly: fix the python path for brew bump-formula-pr'
      run: cd /usr/local/Cellar/python@3.11; ln -s 3.11.6_1 3.11.7
    - name: Bump semgrep.rb
      run: "\n        brew bump-formula-pr --force --no-audit --no-browse --write-only
        \\\n          --message=\"semgrep ${{ inputs.version }}\" --tag=\"v${{ inputs.version
        }}\" semgrep --debug\n      "
    - name: Make the commit
      env:
        GITHUB_TOKEN: ${{ secrets.SEMGREP_HOMEBREW_RELEASE_PAT }}
      run: "\n        cd \"$(brew --repository)/Library/Taps/homebrew/homebrew-core\"\n
        \       git status\n        git diff\n        git config user.name ${{ github.actor
        }}\n        git config user.email ${{ github.actor }}@users.noreply.github.com\n
        \       gh auth setup-git\n        # TODO: we should move this repo in the
        semgrep org\n        git remote add r2c https://github.com/semgrep-release/homebrew-core.git\n
        \       git checkout -b bump-semgrep-${{ inputs.version }}\n        git add
        Formula/s/semgrep.rb\n        git commit -m \"semgrep ${{ inputs.version }}\"\n
        \     "
    - name: Push commit to our fork of homebrew-core
      env:
        GITHUB_TOKEN: ${{ secrets.SEMGREP_HOMEBREW_RELEASE_PAT }}
      run: "\n        cd \"$(brew --repository)/Library/Taps/homebrew/homebrew-core\"\n
        \       git push --set-upstream r2c --force \"bump-semgrep-${{ inputs.version
        }}\"\n      "
      if: ${{ ! inputs.dry-run }}
    - name: Open PR to official homebrew-core repo
      env:
        GITHUB_TOKEN: ${{ secrets.SEMGREP_HOMEBREW_RELEASE_PAT }}
      run: "\n        gh pr create --repo homebrew/homebrew-core \\\n          --base
        master --head \"semgrep-release:bump-semgrep-${{ inputs.version }}\" \\\n
        \         --title=\"semgrep ${{ inputs.version }}\" \\\n          --body \"Bump
        semgrep to version ${{ inputs.version }}\"\n      "
      if: ${{ ! inputs.dry-run }}
  brew-build:
    name: Build Semgrep via Brew from HEAD
    runs-on: macos-12
    steps:
    - run: brew update --debug --verbose
      env:
        HOMEBREW_NO_INSTALL_FROM_API: 1
    - run: brew install semgrep --HEAD --debug || brew link --overwrite semgrep
      env:
        HOMEBREW_NO_INSTALL_FROM_API: 1
        NONINTERACTIVE: 1
    - name: Check installed correctly
      run: brew test semgrep --HEAD
      env:
        HOMEBREW_NO_INSTALL_FROM_API: 1
