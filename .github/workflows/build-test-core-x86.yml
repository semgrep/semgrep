# AUTOGENERATED FROM build-test-core-x86.jsonnet DO NOT MODIFY
name: build-test-core-x86
"on":
  workflow_dispatch:
  workflow_call:
jobs:
  job:
    runs-on: ubuntu-latest
    container: returntocorp/ocaml:alpine-2023-11-07
    env:
      HOME: /root
    steps:
    - name: Make checkout speedy
      run: git config --global fetch.parallel 50
    - uses: actions/checkout@v3
      with:
        submodules: true
    - name: Configure git safedir properly
      run: git config --global --add safe.directory $(pwd)
    - name: Cache ~/.opam
      uses: actions/cache@v3
      env:
        SEGMENT_DOWNLOAD_TIMEOUT_MINS: 2
      with:
        path: ~/.opam
        key: ${{ runner.os }}-${{ runner.arch }}-opam-deps-4.14.0-${{hashFiles('semgrep.opam')}}
    - name: Install dependencies
      run: "\n          eval $(opam env)\n          make install-deps-ALPINE-for-semgrep-core\n
        \         make install-deps-for-semgrep-core\n        "
    - name: Build semgrep-core
      run: opam exec -- make core
    - name: Make artifact
      run: "\n          mkdir -p ocaml-build-artifacts/bin\n          cp bin/semgrep-core
        ocaml-build-artifacts/bin/\n          tar czf ocaml-build-artifacts.tgz ocaml-build-artifacts\n
        \       "
    - uses: actions/upload-artifact@v3
      with:
        path: ocaml-build-artifacts.tgz
        name: ocaml-build-artifacts-release
    - name: Test semgrep-core
      run: opam exec -- make core-test
