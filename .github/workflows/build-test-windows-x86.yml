# AUTOGENERATED FROM build-test-windows-x86.jsonnet DO NOT MODIFY
name: build-test-windows-x86
"on":
  workflow_dispatch:
  workflow_call:
jobs:
  job:
    runs-on: windows-latest
    steps:
    - id: cache-cygwin
      uses: actions/cache@v4
      with:
        path: c:\cygwin
        key: ${{ runner.os }}-cygwin
    - uses: cygwin/cygwin-install-action@master
      if: steps.cache-cygwin.outputs.cache-hit != 'true'
    - run: |
        Invoke-WebRequest "https://github.com/ocaml/opam/releases/download/2.2.0-beta1/opam-2.2.0-beta1-x86_64-preview-for-windows.exe" -OutFile opam.exe
        .\opam.exe init
    # - run: git config --system core.longpaths true
    # - name: Make checkout speedy
    #   run: git config --global fetch.parallel 50
    # - uses: actions/checkout@v3
    #   with:
    #     submodules: true
    # - uses: ocaml/setup-ocaml@v2
    #   with:
    #     ocaml-compiler: "4.14"
    #     opam-repositories: '

    #       opam-repository-mingw: https://github.com/ocaml-opam/opam-repository-mingw.git#sunset

    #       default: https://github.com/ocaml/opam-repository.git

    #       '
    #     opam-local-packages: dont_install_local_packages.opam
    # - name: Set GHA cache for OPAM in _opam
    #   uses: actions/cache@v3
    #   env:
    #     SEGMENT_DOWNLOAD_TIMEOUT_MINS: 2
    #   with:
    #     path: _opam
    #     key: ${{ runner.os }}-${{ runner.arch }}-opam-deps-4.14.0-${{ hashFiles('semgrep.opam')
    #       }}
    # - name: Build tree-sitter
    #   env:
    #     CC: x86_64-w64-mingw32-gcc
    #   run: "\n        cd libs/ocaml-tree-sitter-core\n        ./configure\n        ./scripts/download-tree-sitter
    #     --lazy\n        prefix=\"$(pwd)/tree-sitter\"\n        cd downloads/tree-sitter\n
    #     \       make PREFIX=\"$prefix\" CFLAGS=\"-O3 -Wall -Wextra\"\n        make
    #     PREFIX=\"$prefix\" install\n      "
    # - name: Install deps
    #   run: "\n        export PATH=\"${CYGWIN_ROOT_BIN}:${PATH}\"\n        opam depext
    #     conf-pkg-config conf-gmp conf-libpcre\n        opam install -y ./ ./libs/ocaml-tree-sitter-core
    #     --deps-only\n      "
    # - name: Build semgrep-core
    #   run: "\n        export PATH=\\\"${CYGWIN_ROOT_BIN}:${PATH}\\\"\n        export
    #     TREESITTER_INCDIR=$(pwd)/libs/ocaml-tree-sitter-core/tree-sitter/include\n
    #     \       export TREESITTER_LIBDIR=$(pwd)/libs/ocaml-tree-sitter-core/tree-sitter/lib\n
    #     \       # We have to strip rpath from the tree-sitter projects because there's
    #     no\n        # equivalent in Windows\n        # TODO: investigate removing
    #     rpath from the tree-sitter projects\n        for filename in $(find ./languages/
    #     ./libs/ocaml-tree-sitter-core/ -name dune); do\n          grep -v rpath $filename
    #     > $filename.new\n          mv $filename.new $filename\n        done\n        opam
    #     exec -- dune build _build/install/default/bin/semgrep-core.exe\n      "
    # - name: Test semgrep-core
    #   run: "\n        echo 'print(\\\"foo\\\")' > test.py\n        _build/install/default/bin/semgrep-core.exe
    #     -e 'print($X)' -lang python -json test.py\n      "
    # - name: Package semgrep-core
    #   run: "\n        mkdir archive\n        cp _build/install/default/bin/semgrep-core.exe
    #     archive/\n\n        # TODO: somehow upgrade to the latest flexdll, which should
    #     allow us to statically link these libraries\n        cp d:/cygwin/usr/x86_64-w64-mingw32/sys-root/mingw/bin/libstdc++-6.dll
    #     archive/\n        cp d:/cygwin/usr/x86_64-w64-mingw32/sys-root/mingw/bin/libgcc_s_seh-1.dll
    #     archive/\n        cp d:/cygwin/usr/x86_64-w64-mingw32/sys-root/mingw/bin/libwinpthread-1.dll
    #     archive/\n        cp d:/cygwin/usr/x86_64-w64-mingw32/sys-root/mingw/bin/libpcre-1.dll
    #     archive/\n        cp d:/cygwin/usr/x86_64-w64-mingw32/sys-root/mingw/bin/libgmp-10.dll
    #     archive/\n\n        cd archive\n        tar czvf ocaml-build-artifacts.tgz
    #     *.exe *.dll\n      "
    # - uses: actions/upload-artifact@v3
    #   with:
    #     path: archive/ocaml-build-artifacts.tgz
    #     name: ocaml-build-artifacts-release-w64
