# Makefile to automatically convert the .jsonnet GHA workflows
# to .yml as GHA accepts only this format.
#
# To convert more yml files to jsonnet, install 'yq' and 'jsonnetfmt'
# and run `jsonnetfmt <(cat foo.yml | yq)` to get a first draft.

JSONNET=../../_build/install/default/bin/ojsonnet

LIBS = \
  libs/actions.libsonnet \
  libs/gha.libsonnet \
  libs/semgrep.libsonnet \

OBJS = \
  semgrep.yml lint.yml \
  update-semgrep-rules.yml \
  build-test-core-x86.yml build-test-core-x86-ocaml5.yml \
  build-test-osx-x86.yml build-test-osx-arm64.yml \
  build-test-manylinux-x86.yml build-test-manylinux-aarch64.yml \
  build-test-javascript.yml \
  tests.yml \
  test-e2e-semgrep-ci.yml

all: $(JSONNET) $(OBJS)

$(JSONNET):
	cd ../..; make build-ojsonnet

%.yml: %.jsonnet $(LIBS)
	echo "# AUTOGENERATED FROM $< DO NOT MODIFY" > $@
	$(JSONNET) --yaml $< >> $@
	echo "" >> $@

clean:
	rm -f $(OBJS)
