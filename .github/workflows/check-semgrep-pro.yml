# AUTOGENERATED FROM check-semgrep-pro.jsonnet DO NOT MODIFY
name: check-semgrep-pro
"on":
  workflow_dispatch:
  pull_request:
  push:
    branches:
    - develop
jobs:
  job:
    runs-on: ubuntu-latest
    steps:
    - name: Get JWT for semgrep-ci GitHub App
      id: jwt
      uses: docker://public.ecr.aws/y9k7q4m1/devops/cicd:latest
      env:
        EXPIRATION: 600
        ISSUER: ${{ secrets.SEMGREP_CI_APP_ID }}
        PRIVATE_KEY: ${{ secrets.SEMGREP_CI_APP_KEY }}
    - name: Get token for semgrep-ci GitHub App
      id: token
      run: "\n      TOKEN=\"$(curl -X POST \\\n      -H \"Authorization: Bearer ${{
        steps.jwt.outputs.jwt }}\" \\\n      -H \"Accept: application/vnd.github.v3+json\"
        \\\n      \"https://api.github.com/app/installations/${{ secrets.SEMGREP_CI_APP_INSTALLATION_ID
        }}/access_tokens\" | \\\n      jq -r .token)\"\n      echo \"::add-mask::$TOKEN\"\n
        \     echo \"token=$TOKEN\" >> $GITHUB_OUTPUT\n    "
    - uses: actions/checkout@v3
      with:
        submodules: true
    - name: Setup OCaml and opam
      uses: ocaml/setup-ocaml@v2
      with:
        ocaml-compiler: 4.14.0
    - name: Cache ~/.opam
      uses: actions/cache@v3
      env:
        SEGMENT_DOWNLOAD_TIMEOUT_MINS: 2
      with:
        path: _opam
        key: ${{ runner.os }}-${{ runner.arch }}-opam-deps-4.14.0-_opam-${{ hashFiles('semgrep.opam')
          }}
    - name: Install semgrep dependencies
      run: "\n        eval $(opam env)\n        make install-deps-for-semgrep-core\n
        \       make install-deps\n      "
    - run: sudo apt-get install gh
    - env:
        GITHUB_TOKEN: ${{ steps.token.outputs.token }}
      name: Checkout semgrep-pro
      run: "\n        cd ..\n        gh repo clone semgrep/semgrep-proprietary\n        cd
        semgrep-proprietary\n        git submodule update --init\n      "
    - name: Adjust semgrep-pro to use the semgrep in this PR
      run: "\n        cd ../semgrep-proprietary\n        rm -rf semgrep\n        ln
        -s ../semgrep\n      "
    - name: Ugly hack for setup-ocaml
      run: "\n        cd ../semgrep-proprietary\n        ln -s ../semgrep/_opam\n
        \     "
    - name: Install semgrep-pro dependencies
      run: "\n        cd ../semgrep-proprietary\n        eval $(opam env)\n        make
        install-deps\n      "
    - name: Compile semgrep-pro
      run: "\n        cd ../semgrep-proprietary\n        eval $(opam env)\n        make\n
        \     "
    - name: Test semgrep-pro
      run: "\n        cd ../semgrep-proprietary\n        eval $(opam env)\n        make
        test\n      "
    - env:
        GITHUB_TOKEN: ${{ steps.token.outputs.token }}
      name: Checkout Pro rules
      run: "\n        cd ..\n        gh repo clone semgrep/semgrep-rules-proprietary\n
        \       cd semgrep-rules-proprietary\n        git submodule update --init\n
        \     "
    - name: Test Pro rules
      run: "\n        cd ../semgrep-rules-proprietary/paid\n        # This rule is
        missing a target file\n        rm -f kotlin/ktor/active-debug-code/ktor-development-mode-yaml.yaml\n
        \       # This is much faster than `pysemgrep --test` and it's also stricter.\n
        \       # TODO: Replace with `osemgrep-pro test` when that is ready.\n        ../../semgrep-proprietary/bin/semgrep-core-proprietary
        -test_rules .\n      "
