# AUTOGENERATED FROM build-test-manylinux-x86.jsonnet DO NOT MODIFY
jobs:
  build-wheels:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: true
      - run: apt-get update && apt install -y zip musl-tools software-properties-common python3-pip
      - run: |
          add-apt-repository ppa:deadsnakes/ppa
          apt install -y python3.8
          update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.6 1
          update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.8 2
          update-alternatives --config python3
      - uses: actions/download-artifact@v3
        with:
          name: semgrep-core-x86-artifact
      - run: |
          tar xf artifacts.tgz
          cp artifacts/semgrep-core cli/src/semgrep/bin
          ./scripts/build-wheels.sh
      - uses: actions/upload-artifact@v3
        with:
          name: manylinux-x86-wheel
          path: cli/dist.zip
  test-wheels:
    container: quay.io/pypa/manylinux2014_x86_64
    needs:
      - build-wheels
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v3
        with:
          name: manylinux-x86-wheel
      - run: unzip dist.zip
      - name: install package
        run: /opt/python/cp38-cp38/bin/pip install dist/*.whl
      - name: test package
        run: |
          export PATH=/opt/python/cp38-cp38/bin:$PATH
          semgrep --version
      - name: e2e semgrep-core test
        run: |
          export PATH=/opt/python/cp38-cp38/bin:$PATH
          echo '1 == 1' | semgrep -l python -e '$X == $X' -
name: build-test-manylinux-x86
on:
  workflow_call: null
  workflow_dispatch: null
