# Cron to verify that the Homebrew Core Formula Works.
# This formula is stored in https://github.com/Homebrew/homebrew-core/blob/HEAD/Formula/semgrep.rb
# and "bumped" in release.yml by dawidd6/action-homebrew-bump-formula@v3
#
# This formula is created by our release process with the PR to homebrew/homebrew-core.
# What this workflow does is uses the latest version of the formula at that repo, but
# 'develop' branch source code from our PR. This serves two purposes:
#  - verifies that our changes don't break Brew
#  - gives us time before release to fix these issues and adjust our homebrew formula
#    if needed.

name: Nightly Verification

on:
  workflow_dispatch:
  schedule:
    # every day at 9:26
    - cron: "26 9 * * *"

jobs:
  brew-build:
    name: Build Semgrep via Brew from `returntocorp/semgrep:develop`
    runs-on: macos-12
    # We've had issues with this workflow in the past, and needed to ensure that
    # homebrew wouldn't use the API.
    # See: https://github.com/orgs/Homebrew/discussions/4150, and
    # https://github.com/orgs/Homebrew/discussions/4136
    # There's also much other discussion on this topic available on GH and in the
    # brew discussions.
    steps:
      - name: Brew update
        run: brew update --debug --verbose
      # - run: |
      #     rm '/usr/local/bin/2to3'
      #     rm '/usr/local/bin/2to3-3.11'
      #     rm '/usr/local/bin/idle3'
      #     rm '/usr/local/bin/idle3.11'
      #     rm '/usr/local/bin/pydoc3'
      #     rm '/usr/local/bin/pydoc3.11'
      #     rm '/usr/local/bin/python3'
      #     rm '/usr/local/bin/python3-config'
      - name: Brew Install
        env:
          NONINTERACTIVE: 1
        run: brew install semgrep --debug || brew link --overwrite semgrep
      - name: Check installed correctly
        run: brew test semgrep
      - name: Debug
        run: |
          which semgrep
          semgrep --version
