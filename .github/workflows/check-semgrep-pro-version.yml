# AUTOGENERATED FROM check-semgrep-pro-version.jsonnet DO NOT MODIFY
jobs:
  job:
    permissions:
      contents: write
      id-token: write
    runs-on: ubuntu-22.04
    steps:
      - name: Configure AWS credentials for returntocorp-semgrep-deploy-role
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: us-west-2
          role-duration-seconds: 900
          role-session-name: semgrep-s3-access
          role-to-assume: arn:aws:iam::338683922796:role/returntocorp-semgrep-deploy-role
      - name: Download binaries from S3
        run: aws s3 cp "s3://${{ inputs.bucket-name }}/${{ inputs.manifest-key }}" versions-manifest.json
      - if: ${{ ! inputs.dry-run }}
        name: Check Version
        run: |
          VERSION_EXISTS=$(jq --arg semgrep_version ${{ inputs.semgrep-version }} '.versions | has($semgrep_version)' versions-manifest.json)

          if [ "${VERSION_EXISTS}" = "true" ]; then
              echo "This vesion has a corresponding Semgrep Pro version - continuing."
          else
              echo "This version of semgrep does not yet have a corresponding version of Semgrep Pro."
              echo "Please run a release of Semgrep Pro, and pass in Semgrep Version = ${{ inputs.semgrep-version }}"
              exit 1
          fi
      - if: ${{ inputs.dry-run }}
        name: Check Version - Dry Run
        run: |
          VERSION_EXISTS=$(jq --arg semgrep_version ${{ inputs.semgrep-version }} '.versions | has($semgrep_version)' versions-manifest.json)

          if [ "${VERSION_EXISTS}" = "true" ]; then
              echo "This vesion has a corresponding Semgrep Pro version - continuing."
          else
              echo "This version of semgrep does not yet have a corresponding version of Semgrep Pro."
              echo "Please run a release of Semgrep Pro, and pass in Semgrep Version = ${{ inputs.semgrep-version }} before running a release"
              echo "Job was not blocked because dry-run was true."
          fi
name: check-semgrep-pro-version
on:
  workflow_call:
    inputs:
      bucket-name:
        description: Bucket name (not the ARN) to pull the manifest from.
        required: true
        type: string
      dry-run:
        description: Dry-Run flag determines whether or not the check failing means that the job will actually fail.
        required: true
        type: boolean
      manifest-key:
        description: Name (key) of the manifest JSON file in S3
        required: true
        type: string
      semgrep-version:
        description: The version of Semgrep OSS to add to the manifest
        required: true
        type: string
  workflow_dispatch:
    inputs:
      bucket-name:
        description: Bucket name (not the ARN) to pull the manifest from.
        required: true
        type: string
      dry-run:
        description: Dry-Run flag determines whether or not the check failing means that the job will actually fail.
        required: true
        type: boolean
      manifest-key:
        description: Name (key) of the manifest JSON file in S3
        required: true
        type: string
      semgrep-version:
        description: The version of Semgrep OSS to add to the manifest
        required: true
        type: string
